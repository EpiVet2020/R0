---
title: "Análise comparativa entre Rt de diferentes países"
author: "By: Estagiárias de Epidemiologia da FMV"
date: "Outubro, 2020"
output:
  html_document:
    code_folding: hide
    df_print: paged
    theme: cosmo
    toc: yes
    toc_depth: 3

  html_notebook:
    code_folding: hide
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```


```{css, echo=FALSE}
/* Whole document: */
body{
  font-size: 12pt;
}
```

<br>

## **Introdução**
***
O Número Básico de Reprodução (R0) indica o número médio de casos secundários originados a partir de um caso primário, quando o vírus é introduzido numa população que consiste somente em indivíduos suscetíveis.

Por outro lado, o Número Efetivo de Reprodução (Re ou Rt) indica também, em média, o nº de contágios que cada infetado provoca, mas tem como ponto de partida uma população que já esteve exposta ao vírus. Ou seja, leva em conta as medidas postas em prática para travar a disseminação. 

O valor que fomos calcular neste projeto foi o Rt, sendo um indicador essencial para o estudo da evolução de um surto epidémico, permitindo avaliar a efetividade das medidas de contenção e analisar qual o momento mais adequado para o levantamento das restrições implementadas.

<br>

### Interpretação dos valores de Rt

* Quando R > 1, significa que a epidemia continua a crescer e que o número de novos casos será superior ao número de casos atuais; 
* Por outro lado, quando Rt = 1, ocorre o limiar da transmissão (abaixo deste valor a doença é incapaz de se manter numa população). 

O objetivo mais importante será manter um Rt inferior ou igual a 1 até à disponibilidade de uma vacina eficaz.

<br>

Este relatório tem como objetivo analisar de que forma variou o Rt em Portugal, em comparação com outros países do Mundo. Esta análise foi feita com base nos dados da DGS disponíveis em: https://github.com/dssg-pt/covid19pt-data, para Portugal, e em bases de dados de COVID dos restantes países, que se encontram respetivamente no final de cada análise específica.
Dividimos a nossa análise em duas partes, sendo a primeira respetiva a países pertencentes à União Europeia e, posteriormente, aos países extracomunitários.

<br>
```{r warning=FALSE, message=FALSE, message= FALSE}
#Libraries
library(testthat)
library(rlang)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggthemes)
library(plotly)
library(data.table)
library(ggpubr)
library(devtools)
install_github("holtzy/epuRate")
library(epuRate)
library(EpiEstim)
library(tidyr)
library(lubridate)
library(googlesheets)
require(RCurl)
library(viridis)
library(flexdashboard)
library(here)
library(rjson)
library(jsonlite)
library(RCurl)
library(highcharter)
library(here)
library(purrr)
library(magrittr)
library(RColorBrewer)
library(rjson)
library(readr)
library(readxl)
library(scales)

#Importar dados
covid19pt <-read.csv("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/data.csv", stringsAsFactors = FALSE)


#Data de chr para Date
covid19pt$data <- as.Date(covid19pt$data,"%d-%m-%Y")

```

<br>

## **União Europeia** {.tabset .tabset-fade .tabset-pills}
***
<br>

## Itália

<br>

Pela visualização deste gráfico é possível verificar que o número reprodutivo efetivo apresentou o valor mais elevado no início da pandemia (3 de Março; Rt = 3,16), ligeiramente mais baixo que o Rt inicial para Portugal (embora os casos tenham sido importados mais precocemente em Itália). O confinamento obrigatório, implementado no dia 9 de Março, contribuiu para uma descida abrupta do número de contágios, que atingiu o seu valor mínimo de 0,68 no dia 4 de Junho.
A partir de Junho, com o levantamento de restrições às movimentações e medidas de contenção mais folgadas, ocorreu um aumento sucessivo dos valores de Rt, que culminou num novo pico no dia 26 de Agosto (Rt = 1,53).
No mês de Setembro, a transmissão de infeção parece ter sofrido uma diminuição, mas a partir de Outubro terá surgido um novo pico (18 de Outubro; Rt = 1,57), cujo controlo passou pela implementação de certas medidas novamente, como obrigatoriedade de máscara e encerramento de escolas e universidades.

<br>

```{r pressure, fig.align='center', warning=FALSE}
# ITÁLIA (https://github.com/pcm-dpc/COVID-19/blob/master/dati-andamento-nazionale/dpc-covid19-ita-andamento-nazionale.csv)
italy <- read.csv("https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/legacy/dati-andamento-nazionale/dpc-covid19-ita-andamento-nazionale.csv", stringsAsFactors = FALSE)

## Remover horas e minutos
italy$data <- strftime(italy$data, format = "%Y-%m-%d")

## Alterar para formato de data
italy$data <- as.Date(italy$data,  "%Y-%m-%d")

## Tabela: Data e confirmados novos
it_var <- italy %>%
  select(data, nuovi_positivi)
names(it_var) <- c("data", "confirmados_novos")


## Previsão da evolução
covid_it_var <- it_var  %>%
  filter(it_var$data > as.Date("2020-02-28")) %>%  
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Itália- Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_it <- estimate_R(as.numeric(covid_it_var$confirmados_novos), 
                                method = "uncertain_si",
                                config = sens_configs
)

sample_windows_it <- seq(length(Rt_nonparam_si_it$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_it <- 
  map(.x = sample_windows_it,
      .f = function(x) {
        
        posterior_sample_obj_it <- 
          sample_posterior_R(
            R = Rt_nonparam_si_it,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_it <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_it$R$t_start[x],
            window_t_end = Rt_nonparam_si_it$R$t_end[x],
            date_point = covid_it_var[covid_it_var$t_start == Rt_nonparam_si_it$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_it),
            R_e_q0025 = quantile(posterior_sample_obj_it, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_it, probs = 0.975))
        
        return(posterior_sample_estim_it)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Itália ggplot
## Linhas a adicionar no gráfico
d_it = data.frame(date=as.Date(c("2020-03-09", "2020-06-04", "2020-10-08", "2020-10-15")), Evento=c("Confinamento obrigatório", "Levantamento das restrições às movimentações", "Obrigatoriedade de máscara", "Encerramento de escolas e universidades"))


graph_it<- ggplot(posterior_Rt_it, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "indianred",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                      '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "indianred3") +
  
  labs( title = "Itália - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_it_var$data), max((posterior_Rt_it$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-09", "2020-06-04", "2020-10-08", "2020-10-15"))), linetype= c("twodash", "dotted", "solid", "dotdash"), colour = "darkred", alpha = 0.5) +
  geom_vline(data=d_it, mapping =  aes(xintercept = date, linetype = Evento), size = 1, colour = 'darkred', alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_it, tooltip = "text")
```

<br>

## Alemanha

<br>

No caso da Alemanha, inicialmente 1 pessoa era responsável pelo ocorrência de cerca de 4,07 casos secundários (4 de Março; Rt = 4,07), período durante o qual ocorreu a importação dos primeiros casos infetados. Nos seguintes 5 dias, o valor sofreu um pequeno decréscimo seguido de um novo pico no dia 13 de Março, com Rt de 3,15. Este novo aumento na transmissão foi eficazmente controlado com o encerramento de escolas (dia 13 de Março) e declaração posterior do estado de emergência nacional (22 de Março), apresentando o valor mais baixo de transmissão no dia 16 de Abril (Rt = 0,71). A partir desta data, apesar da reabertura de lojas e escolas ter contribuído para que o número de reprodução efetivo voltasse a apresentar valores acima de 1, este país parece ter conseguido manter os valores de Rt relativamente constantes. 
A 2 de Outubro foi declarado um novo confinamento, desta vez parcial, de forma a prevenir um novo aumento no número de contágios.
<br>

```{r,fig.align='center', warning=FALSE, message= FALSE}
# ALEMANHA (https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0/data)
germany <- fromJSON("https://opendata.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0.geojson")
germany <- germany$features

## Remover horas e minutos
germany$properties$Meldedatum <- strftime(germany$properties$Meldedatum, format = "%Y-%m-%d")
## Alterar para formato de data
germany$properties$Meldedatum <- as.Date(germany$properties$Meldedatum, format = "%Y-%m-%d")

### Ordenar por data
germany <- as.data.frame(germany[order(germany$properties$Meldedatum), ])

### Nº de registos por dia (agregar os confirmados )
ger_var <- as.data.frame(aggregate(x = germany, list(Data = germany$properties$Meldedatum), FUN = length))
ger_var <- ger_var[,1:2]
names(ger_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_ger_var <- ger_var  %>%
  filter(ger_var$data > as.Date("2020-02-28")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Alemanha - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_ger <- estimate_R(as.numeric(covid_ger_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_ger <- seq(length(Rt_nonparam_si_ger$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_ger <- 
  map(.x = sample_windows_ger,
      .f = function(x) {
        
        posterior_sample_obj_ger <- 
          sample_posterior_R(
            R = Rt_nonparam_si_ger,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_ger <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_ger$R$t_start[x],
            window_t_end = Rt_nonparam_si_ger$R$t_end[x],
            date_point = covid_ger_var[covid_ger_var$t_start == Rt_nonparam_si_ger$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_ger),
            R_e_q0025 = quantile(posterior_sample_obj_ger, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_ger, probs = 0.975))
        
        return(posterior_sample_estim_ger)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Alemanha ggplot
## Linhas a adicionar no gráfico
d_ger = data.frame(date=as.Date(c("2020-03-13", "2020-03-22", "2020-04-20", "2020-05-04", "2020-11-02")), Evento=c("Encerramento de escolas", "Estado de Emergência", "Reabertura de lojas", "Reabertura de escolas", "Confinamento parcial"))

graph_ger<- ggplot(posterior_Rt_ger, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "goldenrod",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                      '<br>Rt médio: ', R_e_median))) +  
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "goldenrod1") +
  
  labs( title = "Alemanha - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_ger_var$data), max((posterior_Rt_ger$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) +
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-13", "2020-03-22", "2020-04-20", "2020-05-04", "2020-11-02"))), linetype= c("twodash", "dotted", "dashed", "dotdash", "solid"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_ger, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_ger, tooltip = "text")
```

<br>

## Espanha

<br>

À semelhança do que aconteceu nos restantes países, o maior período de transmissão em Espanha ocorreu no início da pandemia, tendo atingido o valor máximo de 3,04 no dia 2 de Março. Estes valores levaram a que o país declarasse estado de emergência no dia 13 de Março, com a intenção de diminuir a probabilidade de contágio. A partir desta altura, os valores de Rt foram decrescendo de forma considerável, até ao valor mínimo de 0,46 no dia 10 de Maio. 
Por volta desta altura, com o início do desconfinamento, assistiu-se a um aumento do número de contágios, com valores de Rt até 1,53, e mantiveram-se valores de Rt na ordem de 1 até meados de Outubro. Nesta fase, com a declaração de um novo estado de emergência na região de Madrid a 7 de Outubro e a nível nacional no dia 23 do mesmo mês, verificou-se uma descida dos valores de Rt até 0,71, o que confirma a eficácia destas medidas no controlo da doença.

<br>

```{r pressure, fig.align='center', warning=FALSE}
# ESPANHA (https://cnecovid.isciii.es/covid19/#documentaci%C3%B3n-y-datos)
spain <- read.csv("https://cnecovid.isciii.es/covid19/resources/datos_ccaas.csv")

## Alterar para formato Data
spain$fecha <- as.Date(spain$fecha, "%Y-%m-%d")

## Tabela confirmados novos (somar registos por dia (juntar regiões))
spa_var <- as.data.frame(aggregate(spain$num_casos, by = list(spain$fecha), FUN = sum))
names(spa_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_spa_var <- spa_var  %>%
  filter(spa_var$data > as.Date("2020-01-31")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Espanha - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_spa <- estimate_R(as.numeric(covid_spa_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_spa <- seq(length(Rt_nonparam_si_spa$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_spa <- 
  map(.x = sample_windows_spa,
      .f = function(x) {
        
        posterior_sample_obj_spa <- 
          sample_posterior_R(
            R = Rt_nonparam_si_spa,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_spa <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_spa$R$t_start[x],
            window_t_end = Rt_nonparam_si_spa$R$t_end[x],
            date_point = covid_spa_var[covid_spa_var$t_start == Rt_nonparam_si_spa$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_spa),
            R_e_q0025 = quantile(posterior_sample_obj_spa, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_spa, probs = 0.975))
        
        return(posterior_sample_estim_spa)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Espanha ggplot
## Linhas a adicionar no gráfico
d_spa = data.frame(date=as.Date(c("2020-03-15", "2020-05-11", "2020-10-07", "2020-10-25")), Evento=c("Estado de Emergência", "Início do desconfinamento", "Estado de Emergência - Região Autónoma de Madrid", "Estado de Emergência Nacional"))


graph_spa<- ggplot(posterior_Rt_spa, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "thistle3",  alpha = 0.8, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                        '<br>Rt médio: ', R_e_median))) +  
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.3, fill = "thistle2") +
  
  labs( title = "Espanha - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_spa_var$data), max((posterior_Rt_spa$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_spa$R_e_q0975)),
    limits = c(0, NA)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) +
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-15", "2020-05-11", "2020-10-07", "2020-10-25"))), linetype = c("solid", "dotdash", "twodash", "dotted"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_spa, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_spa, tooltip = "text")
```

<br>

## Bélgica

<br>

A partir desde gráfico, é possível constatar que o número de reprodução efetivo inicial atingiu os 2,72 (8 de Março), o que não parece ter sido muito diferente em relação aos restantes países da união europeia. No entanto, neste caso, os dados utilizados só terão começado a ser reportados a partir de 1 de Março. Desde então, com a implementação do confinamento parcial e posteriormente total a nível nacional, o número de contágios diminuiu até um Rt de 0,60 no dia 1 de Maio. 
Até ao final de Julho os valores de Rt foram aumentando gradualmente, embora se tenham mantido mais ou menos sob controlo (inferiores a 1) entre Maio e Junho. O maior valor de Rt voltou a ser registado no dia 17 de Julho (1,56) e posteriormente voltou a apresentar dois novos picos em Setembro e Outubro, respetivamente. Com a implementação de novas restrições a 24 de Setembro, a transmissão de infeção não sofreu uma diminuição imediata, mas a partir de meados de Outubro decresceu de forma considerável até um Rt de 0,58.

<br>

```{r pressure, fig.align='center', warning=FALSE}
# BÉLGICA (https://epistat.wiv-isp.be/covid/)
belgium <- read.csv("https://epistat.sciensano.be/Data/COVID19BE_CASES_AGESEX.csv")

## Alterar para formato de data
belgium$DATE <- as.Date(belgium$DATE, "%Y-%m-%d")

## Tabela de confirmados novos - Soma dos registos diários (juntar regiões)
bel_var <- as.data.frame(aggregate(belgium$CASES, by = list(Data = belgium$DATE), FUN = sum))
names(bel_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_bel_var <- bel_var  %>%
  # Neste caso não se filtrou > 28-02-2020 , uma vez que só reportaram a partir de Março.
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Bélgica - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_bel <- estimate_R(as.numeric(covid_bel_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_bel <- seq(length(Rt_nonparam_si_bel$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_bel <- 
  map(.x = sample_windows_bel,
      .f = function(x) {
        
        posterior_sample_obj_bel <- 
          sample_posterior_R(
            R = Rt_nonparam_si_bel,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_bel <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_bel$R$t_start[x],
            window_t_end = Rt_nonparam_si_bel$R$t_end[x],
            date_point = covid_bel_var[covid_bel_var$t_start == Rt_nonparam_si_bel$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_bel),
            R_e_q0025 = quantile(posterior_sample_obj_bel, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_bel, probs = 0.975))
        
        return(posterior_sample_estim_bel)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Bélgica ggplot
## Linhas a adicionar no gráfico
d_bel = data.frame(date=as.Date(c("2020-03-13", "2020-03-18", "2020-06-08", "2020-09-24")), Evento=c("Confinamento parcial", "Confinamento total", "Reabertura de cafés e restaurantes", "Novas restrições"))

graph_bel<- ggplot(posterior_Rt_bel, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "royalblue2",  alpha = 0.65, size = 1 ,aes(group = 1, text = paste('Data: ', date_point,
                                                                                         '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "royalblue1") +
  
  labs( title = "Bélgica - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_bel_var$data), max((posterior_Rt_bel$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_bel$R_e_q0975)),
    limits = c(0, NA)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-13", "2020-03-18", "2020-06-08", "2020-09-24"))), linetype = c("solid", "twodash", "dotdash", "dotted"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_bel, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_bel, tooltip = "text")
```

<br>

## República Checa

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
# REPÚBLICA CHECA (https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19)
czechr <- read.csv("https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/nakaza.csv")

## Alterar formato para data
czechr$datum <- as.Date(czechr$datum, "%Y-%m-%d")

## Tabela confirmados novos
cz_var <- czechr %>%
  select(datum, prirustkovy_pocet_nakazenych)
names(cz_var) <- c("data", "confirmados_novos")


## Previsão da evolução
covid_cz_var <- cz_var  %>%
  filter(cz_var$data > as.Date("2020-01-27")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Rép. Checa - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)
sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_cz <- estimate_R(as.numeric(covid_cz_var$confirmados_novos), 
                                method = "uncertain_si",
                                config = sens_configs
)

sample_windows_cz <- seq(length(Rt_nonparam_si_cz$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_cz <- 
  map(.x = sample_windows_cz,
      .f = function(x) {
        
        posterior_sample_obj_cz <- 
          sample_posterior_R(
            R = Rt_nonparam_si_cz,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_cz <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_cz$R$t_start[x],
            window_t_end = Rt_nonparam_si_cz$R$t_end[x],
            date_point = covid_cz_var[covid_cz_var$t_start == Rt_nonparam_si_cz$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_cz),
            R_e_q0025 = quantile(posterior_sample_obj_cz, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_cz, probs = 0.975))
        
        return(posterior_sample_estim_cz)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico República Checa ggplot
## Linhas a adicionar no gráfico
d_cz = data.frame(date=as.Date(c("2020-03-12", "2020-05-11", "2020-10-05", "2020-10-22")), Evento=c("Estado de Emergência", "Reabertura de lojas", "Estado de Emergência", "Proibição de movimentações"))

graph_cz <- ggplot(posterior_Rt_cz, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "steelblue3",  alpha = 0.65, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                           '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "steelblue1") +
  
  labs( title = "Républica Checa - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_cz_var$data), max((posterior_Rt_cz$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_cz$R_e_q0975)),
    limits = c(0, NA)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) +
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-12", "2020-05-11", "2020-10-05", "2020-10-22"))), linetype = c("solid", "dotted", "solid", "twodash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_cz, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_cz, tooltip = "text")
```

<br>

## Suíça

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
# SUÍÇA (https://www.bag.admin.ch/bag/en/home/krankheiten/ausbrueche-epidemien-pandemien/aktuelle-ausbrueche-epidemien/novel-cov/situation-schweiz-und-international.html#-640157857)
switzerland <- rio::import(file ="https://www.bag.admin.ch/dam/bag/en/dokumente/mt/k-und-i/aktuelle-ausbrueche-pandemien/2019-nCoV/covid-19-basisdaten-labortests.xlsx.download.xlsx/Dashboard_3_COVID19_labtests_positivity.xlsx")

## Alterar formato para Data
switzerland$Datum <- as.Date(switzerland$Datum, "%Y-%m-%d")

# Selecionar casos positivos diários e criar tabela com a data
swi_var <- switzerland %>%
  filter(Outcome_tests == "Positive") %>%
  select(Datum, Number_of_tests)
names(swi_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_swi_var <- swi_var  %>%
  filter(swi_var$data > as.Date("2020-02-18")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Rép. Checa - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_swi <- estimate_R(as.numeric(covid_swi_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_swi <- seq(length(Rt_nonparam_si_swi$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_swi <- 
  map(.x = sample_windows_swi,
      .f = function(x) {
        
        posterior_sample_obj_swi <- 
          sample_posterior_R(
            R = Rt_nonparam_si_swi,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_swi <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_swi$R$t_start[x],
            window_t_end = Rt_nonparam_si_swi$R$t_end[x],
            date_point = covid_swi_var[covid_swi_var$t_start == Rt_nonparam_si_swi$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_swi),
            R_e_q0025 = quantile(posterior_sample_obj_swi, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_swi, probs = 0.975))
        
        return(posterior_sample_estim_swi)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Suíça ggplot
## Linhas a adicionar no gráfico
d_swi = data.frame(date=as.Date(c("2020-03-13", "2020-03-16", "2020-04-27", "2020-10-19")), Evento=c("Encerramento de escolas, probição de eventos e controlo de fronteiras", "Estado de Emergência", "Levantamento gradual das restrições", "Proibição de ajuntamentos"))

graph_swi<- ggplot(posterior_Rt_swi, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "antiquewhite4",  alpha = 0.65, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                             '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.3, fill = "antiquewhite3") +
  
  labs( title = "Suíça - Evolução do Número Efetivo Reprodutivo longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_swi_var$data), max((posterior_Rt_swi$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_swi$R_e_q0975)),
    limits = c(0, NA)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-13", "2020-03-16", "2020-04-27", "2020-10-19"))), linetype = c("solid", "twodash", "dotted", "dotdash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_swi, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_swi, tooltip = "text")
```
<br>

## Suécia

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
#SUÉCIA (https://experience.arcgis.com/experience/09f821667ce64bf7be6f9f87457ed9aa/page/page_0/)
sweden <- "https://fohm.maps.arcgis.com/sharing/rest/content/items/b5e7488e117749c19881cce45db13f7e/data"
sweden <- rio::import(file = sweden)

## Alterar formato de Data
sweden$Statistikdatum <- as.Date(sweden$Statistikdatum, "%Y-%m-%d")

## Tabela de confirmados novos
swe_var <- sweden %>%
  select(Statistikdatum, Totalt_antal_fall)
names(swe_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_swe_var <- swe_var  %>%
  filter(swe_var$data > as.Date("2020-02-04")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Suécia- Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)
sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_swe <- estimate_R(as.numeric(covid_swe_var$confirmados_novos),
                                 method = "uncertain_si",
                                 config = sens_configs)

sample_windows_swe <- seq(length(Rt_nonparam_si_swe$R$t_start))

# Criar um data frame com valores de R
posterior_Rt_swe <- 
  map(
    .x = sample_windows_swe,
    .f = function(x) {
      
      posterior_sample_obj_swe <- 
        sample_posterior_R(
          R = Rt_nonparam_si_swe,
          n = 1000, 
          window = x
        )
      
      posterior_sample_estim_swe <- 
        data.frame(
          window_index = x,
          window_t_start = Rt_nonparam_si_swe$R$t_start[x],
          window_t_end = Rt_nonparam_si_swe$R$t_end[x],
          date_point = covid_swe_var[covid_swe_var$t_start == Rt_nonparam_si_swe$R$t_end[x], "data"],
          R_e_median = median(posterior_sample_obj_swe),
          R_e_q0025 = quantile(posterior_sample_obj_swe, probs = 0.025),
          R_e_q0975 = quantile(posterior_sample_obj_swe, probs = 0.975)
        )
      
      return(posterior_sample_estim_swe)
      
    }
  ) %>% 
  reduce(bind_rows)

#Grafico Suécia 
## Linhas a adicionar no gráfico
d_swe = data.frame(date=as.Date(c("2020-03-17", "2020-03-19", "2020-03-27", "2020-11-01")), Evento=c("Recomendação de teletrabalho", "Encerramento das escolas", "Proibição de ajuntamentos com mais de 50 pessoas", "Novas medidas de restrição"))

graph_swe <- ggplot(posterior_Rt_swe, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "yellow4",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                      '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "yellow3") +
  
  labs( title = "Suécia - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:FOHM ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_swe_var$data), max(posterior_Rt_swe$date_point))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_swe$R_e_q0975)),
    limits = c(0, NA)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-17", "2020-03-19", "2020-03-27", "2020-11-01"))), linetype = c("dotdash", "solid", "dotted", "twodash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_swe, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

#Tornar o grafico interativo
ggplotly(graph_swe, tooltip = "text")
```

<br>

## **Extracomunitários** {.tabset .tabset-fade .tabset-pills}
***
<br>

## Reino Unido
<br>

No caso do Reino Unido, o primeiro pico de transmissão a 8 de Fevereiro (Rt = 4,83) correspondeu aos primeiros casos de COVID19 confirmados no país, tendo posteriormente diminuído uma vez que o número de novos casos voltou a ter valores mínimos até ao início de Janeiro. Assim, a partir de dia 20 de Fevereiro, o Rt sofreu uma subida repentina até valores na ordem dos 4,88, que correspondeu ao período de maior transmissão de infeção no país. 
Ao longo de Março, os valores de contágio foram diminuindo, sendo esta descida ainda mais reforçada após a implementação de confinamento obrigatório no dia 24 de Março (embora um pouco mais tardiamente que os restantes países). Desta forma, só a partir de Maio é que os valores de Rt se mantiveram abaixo de 1 e foi ainda implementada quarentena obrigatória para todos os passageiros de chegada ao Reino Unido a partir de dia 22 deste mês.
Apesar de todas as medidas implementadas, a esperada segunda vaga de infeções não foi prevenida e desde Julho que os valores de Rt voltaram a aumentar até um novo pico a 7 de Setembro (Rt = 1,52). Na medida de controlar novos surtos, procedeu-se à proibição de ajuntamentos e, mais tarde, o país viu-se obrigado a recorrer a um novo confinamento obrigatório no dia 5 de Novembro, que é expectável que volte a reduzir os valores de Rt abaixo de 1.
<br>

```{r pressure, fig.align='center', warning=FALSE}
# REINO UNIDO (https://coronavirus.data.gov.uk/cases)
uk <- fromJSON("https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=overview&structure=%7B%22areaType%22:%22areaType%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22date%22:%22date%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json")
uk <- uk$data

## Alterar para formato Data
uk$date <- as.Date(uk$date, "%Y-%m-%d")

### Ordenar por data
uk <- as.data.frame(uk[order(uk$date), ])

## Tabela confirmados novos
uk_var <- uk %>%
  select(date, newCasesBySpecimenDate)
names(uk_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_uk_var <- uk_var  %>%
  filter(uk_var$data > as.Date("2020-01-30")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Reino Unido - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_uk <- estimate_R(as.numeric(covid_uk_var$confirmados_novos), 
                                method = "uncertain_si",
                                config = sens_configs
)

sample_windows_uk <- seq(length(Rt_nonparam_si_uk$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_uk <- 
  map(.x = sample_windows_uk,
      .f = function(x) {
        
        posterior_sample_obj_uk <- 
          sample_posterior_R(
            R = Rt_nonparam_si_uk,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_uk <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_uk$R$t_start[x],
            window_t_end = Rt_nonparam_si_uk$R$t_end[x],
            date_point = covid_uk_var[covid_uk_var$t_start == Rt_nonparam_si_uk$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_uk),
            R_e_q0025 = quantile(posterior_sample_obj_uk, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_uk, probs = 0.975))
        
        return(posterior_sample_estim_uk)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Reino Unido ggplot
## Linhas a adicionar no gráfico
d_uk = data.frame(date=as.Date(c("2020-03-24", "2020-05-22", "2020-09-14", "2020-11-05")), Evento=c("Confinamento obrigatório", "Quarentena obrigatória para quem chega", "Proibição de ajuntamentos", "Confinamento obrigatório"))

graph_uk <- ggplot(posterior_Rt_uk, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "plum4",  alpha = 0.65, size = 1,  aes(group = 1, text = paste('Data: ', date_point,
                                                                                      '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.2, fill = "rosybrown2") +
  
  labs( title = "Reino Unido - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_uk_var$data), max((posterior_Rt_uk$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-24", "2020-05-22", "2020-09-14", "2020-11-05"))), linetype = c("solid", "dotted", "twodash", "solid"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_uk, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)

### Tornar gráfico interativo
ggplotly(graph_uk, tooltip = "text")
```

<br>

## Austrália

<br>

Pela observação do gráfico, pode-se constatar que a Austrália apresentou uma transmissão inicial de infeção muito considerável (Rt = 9.996; 21 de Fevereiro), tendo posteriormente ...

<br>

```{r pressure, fig.align='center', warning=FALSE}
#AUSTRÁLIA (https://github.com/M3IT/COVID-19_Data/blob/master/Data/COVID_AU_national_daily_change.csv)
australia <- read.csv("https://raw.githubusercontent.com/M3IT/COVID-19_Data/master/Data/COVID_AU_national_daily_change.csv")

## Alterar para formato Data
australia$date <- as.Date(australia$date, "%Y-%m-%d")

## Tabela confirmados novos
aus_var <- australia %>%
  select(date, confirmed)
names(aus_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_aus_var <- aus_var  %>%
  filter(aus_var$data > as.Date("2020-01-25")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Australia- Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_aus <- estimate_R(as.numeric(covid_aus_var$confirmados_novos),
                                 method = "uncertain_si",
                                 config = sens_configs)

sample_windows_aus <- seq(length(Rt_nonparam_si_aus$R$t_start))

# Criar um data frame com valores de R
posterior_Rt_aus <- 
  map(
    .x = sample_windows_aus,
    .f = function(x) {
      
      posterior_sample_obj_aus <- 
        sample_posterior_R(
          R = Rt_nonparam_si_aus,
          n = 1000, 
          window = x
        )
      
      posterior_sample_estim_aus <- 
        data.frame(
          window_index = x,
          window_t_start = Rt_nonparam_si_aus$R$t_start[x],
          window_t_end = Rt_nonparam_si_aus$R$t_end[x],
          date_point = covid_aus_var[covid_aus_var$t_start == Rt_nonparam_si_aus$R$t_end[x], "data"],
          R_e_median = median(posterior_sample_obj_aus),
          R_e_q0025 = quantile(posterior_sample_obj_aus, probs = 0.025),
          R_e_q0975 = quantile(posterior_sample_obj_aus, probs = 0.975)
        )
      
      return(posterior_sample_estim_aus)
      
    }
  ) %>% 
  reduce(bind_rows)

#Grafico Australia
## Linhas a adicionar no gráfico
d_aus = data.frame(date=as.Date(c("2020-03-16", "2020-03-20", "2020-06-30", "2020-08-02", "2020-09-27")), Evento=c("Estado de Emergência - estado Victoria", "Encerramento de fronteiras", "Confinamento obrigatório - estado Victoria", "Estado de Emergência - estado Victoria", "Levantamento gradual das medidas de restrição"))

graph_aus<- ggplot(posterior_Rt_aus, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "cyan4",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                  '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "cyan3") +
  
  labs( title = " Austrália - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados: ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_aus_var$data), max(posterior_Rt_aus$date_point))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-16", "2020-03-20", "2020-06-30", "2020-08-02", "2020-09-27"))), linetype = c("dotted", "twodash", "solid", "dotted", "dotdash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_aus, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)


#Tornar o grafico interativo
ggplotly(graph_aus, tooltip = "text")
```

<br>

## Nova Zelândia

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}

```
<br>

## Índia

<br>

Como podemos observar no gráfico, a Índia apresentou valores de transmissão na ordem dos 37 no início de março o que, ainda assim, poderá ser enviesado devido à possibilidade do número de novos casos confirmados poder ter sido subestimado. Ainda assim, trata-se de um valor mais elevado que os restantes países, o que pode refletir a dificuldade de implementação de medidas de restrição neste país. A partir de 4 de março começou a ser realizada a triagem a todos os passageiros e, mais tarde, a 25 de Março foi implementado o confinamento obrigatório. 
Embora estas medidas tenham contribuído para diminuir os valores até perto do limiar de tranmissão (Rt ≂ 1), não conseguiram controlar a disseminação da doença até, pelo menos, 19 de Setembro (Rt = 1,004). A partir desde dia, o número de reprodução efetivo diminuiu ligeiramente e manteve-se abaixo de 1 até Novembro, embora o país tenha continuado a apresentar um número de novos casos considerável (50465 novos confirmados no dia 4 de Novembro), o que pode ser explicado por uma maior dificuldade de testagem.

<br>

```{r pressure, fig.align='center', warning=FALSE}
#ÍNDIA (https://api.covid19india.org/documentation/csv/)
india <- read.csv("https://api.covid19india.org/csv/latest/case_time_series.csv")

india$Date_YMD <- as.Date(india$Date_YMD, "%Y-%m-%d")

# Tabela
india_var <- india %>%
  select(Date_YMD, Daily.Confirmed)
names(india_var) <- c("data", "confirmados_novos")

# Previsão da evolução - acrescentar coluna numerada 
covid_india_var <- india_var  %>%
  filter(india_var$data > as.Date("2020-01-31")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

### Cálculo do Rt India- Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )


## Aplicar a função Estimate_R
Rt_nonparam_si_india <- estimate_R(as.numeric(covid_india_var$confirmados_novos),
                                   method = "uncertain_si",
                                   config = sens_configs)

sample_windows_india <- seq(length(Rt_nonparam_si_india$R$t_start))

# Criar um data frame com valores de R
posterior_Rt_india <- 
  map(
    .x = sample_windows_india,
    .f = function(x) {
      
      posterior_sample_obj_india <- 
        sample_posterior_R(
          R = Rt_nonparam_si_india,
          n = 1000, 
          window = x
        )
      
      posterior_sample_estim_india <- 
        data.frame(
          window_index = x,
          window_t_start = Rt_nonparam_si_india$R$t_start[x],
          window_t_end = Rt_nonparam_si_india$R$t_end[x],
          date_point = covid_india_var[covid_india_var$t_start == Rt_nonparam_si_india$R$t_end[x], "data"],
          R_e_median = median(posterior_sample_obj_india),
          R_e_q0025 = quantile(posterior_sample_obj_india, probs = 0.025),
          R_e_q0975 = quantile(posterior_sample_obj_india, probs = 0.975)
        )
      
      return(posterior_sample_estim_india)
      
    }
  ) %>% 
  reduce(bind_rows)

#Grafico Índia
## Linhas a adicionar no gráfico
d_ind = data.frame(date=as.Date(c("2020-03-04", "2020-03-25", "2020-06-08")), Evento=c("Triagem obrigatória a todos os passageiros", "Confinamento obrigatório", "Levantamento gradual das medidas de restrição"))

graph_ind<- ggplot(posterior_Rt_india, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "darkcyan",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                     '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "darkcyan") +
  
  labs( title = "Índia - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados: ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 3),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_india_var$data), max(posterior_Rt_india$date_point))
  ) +
  
  scale_y_continuous(
    breaks = seq(from = 0, to = 90, by = 5),
    limits = c(0, 90)
  ) +
  
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-04", "2020-03-25", "2020-06-08"))), linetype = c("dotted", "solid", "twodash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_ind, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)


#Tornar o grafico interativo
ggplotly(graph_ind, tooltip = "text")
```

<br>

## Hong Kong

<br>

Em Hong Kong, como é possível verificar no gráfico, os valores de transmissão iniciais não atingiram valores tão elevados quanto outros países, tendo atingido um valor de Rt de 2,798 a 20 de março. Com o encerramento geral de fronteiras, observou-se uma diminuição considerável dos valores de contágio no final de março, tendo assumido o seu mínimo a 18 de Abril (Rt = 0,258). 
A partir desta altura, foi-se assistindo a um pequeno aumento no número de novos casos confirmados, que justificou um aumento dos valores de Rt acima do limiar de transmissibilidade (Rt > 1). Apesar do número de transmissões parecer estar novamente a ser controlado após dia 30 de abril, surgiram dois novos picos, a 23 de junho e 10 de julho, que justificaram o consequente maior número de novos positivos em Hong Kong até então.
Com a implementação de novas medidas de restrição a 20 de julho, observou-se um decréscimo acentuado da transmissibilidade, só voltando a apresentar valores de Rt acima de 1 a partir de Setembro. 
Na sequência dos protestos a que se tem assistido em Hong Kong, implementou-se a proibição de utilização de máscara neste contexto, que apesar de apenas entrar em vigor para as pessoas que participem em manifestações ilegais e recorram à violência, pode ter contribuído para um aumento do número de transmissões neste período crítico da doença.


<br>

```{r pressure, fig.align='center', warning=FALSE}
# HONG KONG (https://data.gov.hk/en-data/dataset/hk-dh-chpsebcddr-novel-infectious-agent)
hk <- read.csv("http://www.chp.gov.hk/files/misc/enhanced_sur_covid_19_eng.csv")

## Alterar formato de Data
hk$Report.date <- as.Date(hk$Report.date, format = "%d/%m/%Y")

## Selecionar apenas os casos confirmados
hk_var <- hk %>%
  filter(Confirmed.probable == "Confirmed")

## Agrupar o nº de registos por dia
hk_var <- as.data.frame(aggregate(x = hk_var, list(hk_var$Report.date), FUN = length))

## Criar tabela de confirmados novos
hk_var <- hk_var %>%
  select(Group.1, Report.date)
names(hk_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_hk_var <- hk_var  %>%
  filter(hk_var$data > as.Date("2020-02-28")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt HK - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_hk <- estimate_R(as.numeric(covid_hk_var$confirmados_novos), 
                                method = "uncertain_si",
                                config = sens_configs
)

sample_windows_hk <- seq(length(Rt_nonparam_si_hk$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_hk <- 
  map(.x = sample_windows_hk,
      .f = function(x) {
        
        posterior_sample_obj_hk <- 
          sample_posterior_R(
            R = Rt_nonparam_si_hk,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_hk <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_hk$R$t_start[x],
            window_t_end = Rt_nonparam_si_hk$R$t_end[x],
            date_point = covid_hk_var[covid_hk_var$t_start == Rt_nonparam_si_hk$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_hk),
            R_e_q0025 = quantile(posterior_sample_obj_hk, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_hk, probs = 0.975))
        
        return(posterior_sample_estim_hk)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Hong Kong ggplot
## Linhas a adicionar no gráfico
d_hk = data.frame(date=as.Date(c("2020-03-25", "2020-07-20", "2020-10-04")), Evento=c("Encerramento de fronteiras", "Novas medidas de restrição", "Proibição de máscara nos protestos"))

graph_hk <- ggplot(posterior_Rt_hk, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "lightseagreen",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                             '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "lightseagreen") +
  
  labs( title = "Hong Kong - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_hk_var$data), max((posterior_Rt_hk$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-25", "2020-07-20", "2020-10-04"))), linetype = c("solid", "twodash", "dotted"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_hk, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)



### Tornar gráfico interativo
ggplotly(graph_hk, tooltip = "text")
```

<br>

## China

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
#CHINA (https://covid19.who.int/table)
china <- read.csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

## Alterar formato para data
china$Date_reported <- as.Date(china$Date_reported, "%Y-%m-%d")

## Criar tabela confirmados novos
chi_var <- china %>%
  filter(Country == "China") %>%
  select(Date_reported, New_cases)
names(chi_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_chi_var <- chi_var  %>%
  filter(chi_var$data > as.Date("2020-01-03")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt China - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_chi <- estimate_R(as.numeric(covid_chi_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_chi <- seq(length(Rt_nonparam_si_chi$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_chi <- 
  map(.x = sample_windows_chi,
      .f = function(x) {
        
        posterior_sample_obj_chi <- 
          sample_posterior_R(
            R = Rt_nonparam_si_chi,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_chi <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_chi$R$t_start[x],
            window_t_end = Rt_nonparam_si_chi$R$t_end[x],
            date_point = covid_chi_var[covid_chi_var$t_start == Rt_nonparam_si_chi$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_chi),
            R_e_q0025 = quantile(posterior_sample_obj_chi, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_chi, probs = 0.975))
        
        return(posterior_sample_estim_chi)}
  ) %>% 
  
  reduce(bind_rows)

## Gráfico China ggplot
## Linhas a adicionar no gráfico
d_chi = data.frame(date=as.Date(c("2020-03-22", "2020-07-15", "2020-08-27", "2020-10-26")), Evento=c("Desconfinamento gradual em Hubei", "Confinamento total em Xinjiang", "Desconfinamento gradual em Xinjiang", "Confinamento parcial em Xinjiang"))

graph_chi <- ggplot(posterior_Rt_chi, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "chocolate3",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                         '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "chocolate1") +
  
  labs( title = " China - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_chi_var$data), max((posterior_Rt_chi$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-22", "2020-07-15", "2020-08-27", "2020-10-26"))), linetype = c("solid", "twodash", "dotted", "dotdash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_chi, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)


### Tornar gráfico interativo
ggplotly(graph_chi, tooltip = "text")
```
<br>

## Estados Unidos da América

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
# EUA (https://covid.cdc.gov/covid-data-tracker/#cases_casesinlast7days ou https://data.cdc.gov/Case-Surveillance/COVID-19-Case-Surveillance-Public-Use-Data/vbim-akqf)
usa <- "https://data.cdc.gov/api/views/vbim-akqf/rows.csv?accessType=DOWNLOAD&bom=true&format=true"
usa <- as.data.frame(rio::import(file = usa))

## Alterar para formato Data
usa$cdc_report_dt <- as.Date(usa$cdc_report_dt, "%Y/%m/%d")

## Ordenar por data
usa <- as.data.frame(usa[order(usa$cdc_report_dt), ])

## Agrupar confirmados diários
usa_var <- usa %>%
  filter(current_status == "Laboratory-confirmed case") #selecionar apenas casos confirmados
usa_var <- as.data.frame(aggregate(x = usa_var, list(usa_var$cdc_report_dt), FUN = length)) #nº registos por dia

## Criar tabela confirmados novos
usa_var <- usa_var[, 1:2]
names(usa_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_usa_var <- usa_var  %>%
  filter(usa_var$data > as.Date("2020-01-29")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt USA - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_usa <- estimate_R(as.numeric(covid_usa_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_usa <- seq(length(Rt_nonparam_si_usa$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_usa <- 
  map(.x = sample_windows_usa,
      .f = function(x) {
        
        posterior_sample_obj_usa <- 
          sample_posterior_R(
            R = Rt_nonparam_si_usa,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_usa <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_usa$R$t_start[x],
            window_t_end = Rt_nonparam_si_usa$R$t_end[x],
            date_point = covid_usa_var[covid_usa_var$t_start == Rt_nonparam_si_usa$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_usa),
            R_e_q0025 = quantile(posterior_sample_obj_usa, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_usa, probs = 0.975))
        
        return(posterior_sample_estim_usa)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico USA ggplot
## Linhas a adicionar no gráfico
d_usa = data.frame(date=as.Date(c("2020-03-13", "2020-03-25", "2020-04-13")), Evento=c("Estado de Emergência", "Confinamento total", "Estado de Calamidade"))

graph_usa <- ggplot(posterior_Rt_usa, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "royalblue4",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                         '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "royalblue2") +
  
  labs( title = " Estados Unidos da América - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_usa_var$data), max((posterior_Rt_usa$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-13", "2020-03-25", "2020-04-13"))), linetype = c("dotted", "solid", "twodash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_usa, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)


### Tornar gráfico interativo
ggplotly(graph_usa, tooltip = "text")
```

<br>

## Japão

<br>

No Japão, podemos verificar que o valor máximo de Rt se verificou no dia 18 de fevereiro (Rt = 3.09), altura em que ainda não tinham sido implementadas medidas de restrição e de distanciamento social, levando assim a uma maior transmissão de vírus. No dia 29 do mês seguinte, foi atingido um novo pico de 2.03, no entanto a curva iniciou a sua descida logo após esta data com a declaração do Estado de Emergência no dia 7 de abril. Apesar deste não obrigar ao confinamento da população, sendo apenas voluntário, foi suficiente para fazer o Rt decrescer até ao valor mínimo de 0.49 ao dia 11 de maio. Duas semanas mais tarde, o Estado de Emergência foi suspenso (25 de maio) e, a partir essa data e até 4 de julho, que se registou um aumento progressivo do Rt. Desde então que o Rt tem vindo a diminuir e, mais recentemente, a estabilizar em valores bastante próximos do 1, o que indica uma desaceleração na transmissão. 

<br>

```{r pressure, fig.align='center', warning=FALSE}
#JAPÃO - alterar data do j.son todos os dias (https://github.com/reustle/covid19japan-data/tree/master/docs/summary)
japan <- fromJSON("https://raw.githubusercontent.com/reustle/covid19japan-data/master/docs/summary/2020-10-24.json")
japan <- japan$daily

## Alterar formato para data
japan$date <- as.Date(japan$date, "%Y-%m-%d")

## Criar tabela confirmados novos
jap_var <- japan %>%
  select(confirmed, date)
jap_var <- jap_var[, c(2,1)] #trocar posição das colunas
names(jap_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_jap_var <- jap_var  %>%
  filter(jap_var$data > as.Date("2020-02-10")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Japão - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_jap <- estimate_R(as.numeric(covid_jap_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_jap <- seq(length(Rt_nonparam_si_jap$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_jap <- 
  map(.x = sample_windows_jap,
      .f = function(x) {
        
        posterior_sample_obj_jap <- 
          sample_posterior_R(
            R = Rt_nonparam_si_jap,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_jap <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_jap$R$t_start[x],
            window_t_end = Rt_nonparam_si_jap$R$t_end[x],
            date_point = covid_jap_var[covid_jap_var$t_start == Rt_nonparam_si_jap$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_jap),
            R_e_q0025 = quantile(posterior_sample_obj_jap, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_jap, probs = 0.975))
        
        return(posterior_sample_estim_jap)}
  ) %>% 
  
  reduce(bind_rows)


## Gráfico Japão ggplot
## Linhas a adicionar no gráfico
d_jap = data.frame(date=as.Date(c("2020-04-07", "2020-05-25")), Evento=c("Estado de Emergência com confinamento voluntário", "Suspensão do Estado de Emergência"))

graph_jap <- ggplot(posterior_Rt_jap, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "royalblue",  alpha = 0.5, size = 1, aes(group = 1, text = paste('Data: ', date_point,
                                                                                         '<br>Rt médio: ', R_e_median))) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "royalblue") +
  
  labs( title = " Japão - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1)
  ) +
  
  scale_x_date(
    date_breaks = "2 weeks", labels = date_format("%b %d"),
    limits = c(min(covid_jap_var$data), max((posterior_Rt_jap$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:10,
    limits = c(0, 10)
  ) +
  geom_hline(yintercept = 1, colour= "grey65", alpha= 0.4) + 
  geom_vline(xintercept = as.numeric(as.Date(c("2020-04-07", "2020-05-25"))), linetype = c("solid", "twodash"), colour = "darkred" , alpha = 0.5) +
  geom_vline(data=d_jap, mapping =  aes(xintercept = date, linetype = Evento, ), size = 1, colour = "darkred", alpha = 0.5, show.legend = TRUE)


### Tornar gráfico interativo
ggplotly(graph_jap, tooltip = "text")
```

<br>

## México

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}

```

<br>

## Coreia do Sul

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}

# COREIA DO SUL (https://github.com/owid/covid-19-data/blob/master/public/data/ecdc/new_cases.csv)
korea <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/ecdc/new_cases.csv")

## Alterar formato para data
korea$date <- as.Date(korea$date, "%Y-%m-%d")

## Criar tabela confirmados novos
kor_var <- korea %>% 
  select(date, South.Korea)
names(kor_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_kor_var <- kor_var  %>%
  filter(kor_var$data > as.Date("2020-02-28")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Coreia do Sul - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_kor <- estimate_R(as.numeric(covid_kor_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_kor <- seq(length(Rt_nonparam_si_kor$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_kor <- 
  map(.x = sample_windows_kor,
      .f = function(x) {
        
        posterior_sample_obj_kor <- 
          sample_posterior_R(
            R = Rt_nonparam_si_kor,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_kor <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_kor$R$t_start[x],
            window_t_end = Rt_nonparam_si_kor$R$t_end[x],
            date_point = covid_kor_var[covid_kor_var$t_start == Rt_nonparam_si_kor$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_kor),
            R_e_q0025 = quantile(posterior_sample_obj_kor, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_kor, probs = 0.975))
        
        return(posterior_sample_estim_kor)}
  ) %>% 
  
  reduce(bind_rows)

## Gráfico Coreia do Sul ggplot

graph_kor <- ggplot(posterior_Rt_kor, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "chocolate3",  alpha = 0.5, size = 1.5) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "chocolate1") +
  
  labs( title = " Coreia do Sul - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
  ) +
  
  scale_x_date(
    date_breaks = "1 month",
    limits = c(min(covid_kor_var$data), max((posterior_Rt_kor$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_kor$R_e_q0975)),
    limits = c(0, NA)
  ) +
  geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4)

### Tornar gráfico interativo
ggplotly(graph_kor) %>%
  layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                       "Nº de reprodução efetivo (Rt)",
                                       rep("&nbsp;", 20),
                                       rep("\n&nbsp;", 2)),
                                     collapse = "")))
```

<br>

## Brasil

<br>

TEXTO

<br>

```{r pressure, fig.align='center', warning=FALSE}
#BRASIL (https://covid19.who.int/table)
brasil <- read.csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")

## Alterar formato para data
brasil$ï..Date_reported <- as.Date(brasil$ï..Date_reported, "%Y-%m-%d")

## Criar tabela confirmados novos
bra_var <- brasil %>%
  filter(Country == "Brazil") %>%
  select(ï..Date_reported, New_cases)
names(bra_var) <- c("data", "confirmados_novos")

## Previsão da evolução
covid_bra_var <- bra_var  %>%
  filter(bra_var$data > as.Date("2020-02-28")) %>% 
  dplyr::mutate(t_start = dplyr::row_number())

## Cálculo do Rt Brasil - Uncertainty method --> "uncertain_si"
### Serial Interval (c/ base nos valores anteriores)

sens_configs <- 
  make_config(
    list(
      mean_si = 4.7, std_mean_si = 0.7,
      min_mean_si = 3.7, max_mean_si = 6.0,
      std_si = 2.9, std_std_si = 0.5,
      min_std_si = 1.9, max_std_si = 4.9,
      n1 = 1000,
      n2 = 100,
      seed = 123456789
    )
  )

## Aplicar a função Estimate_R
Rt_nonparam_si_bra <- estimate_R(as.numeric(covid_bra_var$confirmados_novos), 
                                 method = "uncertain_si",
                                 config = sens_configs
)

sample_windows_bra <- seq(length(Rt_nonparam_si_bra$R$t_start))

## Criar um data frame com valores de R
posterior_Rt_bra <- 
  map(.x = sample_windows_bra,
      .f = function(x) {
        
        posterior_sample_obj_bra <- 
          sample_posterior_R(
            R = Rt_nonparam_si_bra,
            n = 1000, 
            window = x )
        
        posterior_sample_estim_bra <- 
          data.frame(
            window_index = x,
            window_t_start = Rt_nonparam_si_bra$R$t_start[x],
            window_t_end = Rt_nonparam_si_bra$R$t_end[x],
            date_point = covid_bra_var[covid_bra_var$t_start == Rt_nonparam_si_bra$R$t_end[x], "data"],
            R_e_median = median(posterior_sample_obj_bra),
            R_e_q0025 = quantile(posterior_sample_obj_bra, probs = 0.025),
            R_e_q0975 = quantile(posterior_sample_obj_bra, probs = 0.975))
        
        return(posterior_sample_estim_bra)}
  ) %>% 
  
  reduce(bind_rows)

## Gráfico Brasil ggplot

graph_bra <- ggplot(posterior_Rt_bra, aes(x = date_point, y = R_e_median)) +
  geom_line(colour = "chocolate3",  alpha = 0.5, size = 1.5) +
  geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "chocolate1") +
  
  labs( title = " Brasil - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
        subtitle = "Fonte de dados:  ",
        x = "Data",
        y = "Nº de reprodução efetivo (Rt)"
  ) +
  
  theme_minimal() +
  
  theme(axis.title = element_text(size = 10, hjust = 0.5),
        plot.subtitle = element_text(size= 8),
        axis.title.x = element_text(size = 7),
        axis.title.y = element_text(size = 7),
  ) +
  
  scale_x_date(
    date_breaks = "1 month",
    limits = c(min(covid_bra_var$data), max((posterior_Rt_bra$date_point)))
  ) +
  
  scale_y_continuous(
    breaks = 0:ceiling(max(posterior_Rt_bra$R_e_q0975)),
    limits = c(0, NA)
  ) +
  geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4)

### Tornar gráfico interativo
ggplotly(graph_bra) %>%
  layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                       "Nº de reprodução efetivo (Rt)",
                                       rep("&nbsp;", 20),
                                       rep("\n&nbsp;", 2)),
                                     collapse = "")))

```


