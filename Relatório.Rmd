---
title: "Estimativa do Número de Reprodução Efetivo (Rt) da COVID19"
subtitle: "Portugal e Administrações Regionais de Saúde"
author: "By: Estagiárias de Epidemiologia da FMV"
date: "Outubro, 2020"
output:
  html_document:
    code_folding: hide
    df_print: paged
    theme: lumen
    toc: yes
    toc_float: yes
    toc_depth: 3
    includes:
      before_body: header.Rhtml
  html_notebook:
    code_folding: hide
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```


```{css, echo=FALSE}
/* Whole document: */
body{
  font-size: 12pt;
}
```

<br>

## **Introdução**
***
O Número Básico de Reprodução (R0) indica, em média, quantas pessoas são infetadas por um único doente. Ou seja, é o número médio de casos secundários originados a partir de um caso primário, quando o vírus é introduzido numa população que consiste somente em indivíduos suscetíveis.

Por outro lado, o Número Efetivo de Reprodução (Re ou Rt) indica, em média, o nº de infeções que cada doente provoca, mas tem como ponto de partida uma população que já esteve exposta ao vírus. Ou seja, leva em conta as medidas postas em prática para travar a disseminação.

O valor do Rt é um indicador essencial para o estudo da evolução de um surto epidémico, que pode ser usado para medir a efetividade das medidas de contenção e atraso e ainda avaliar o momento mais adequado para o levantamento das restrições implementadas.

Desta forma, quando Rt = 1, ocorre o limiar da transmissão (abaixo deste valor a doença é incapaz de se manter numa população). O objetivo mais importante será manter um Rt inferior ou igual a 1 até à disponibilidade de uma vacina eficaz.

Este relatório tem como objetivo analisar de que forma se tem alterado o Rt em Portugal e, mais especificamente, em cada região do país. Esta análise foi feita com base nos dados da DGS disponíveis em: https://github.com/dssg-pt/covid19pt-data.
<br>
<br>

<ul>
  <li>Portugal</li>
  <li>Administrações Regionais de Saúde (ARS's)<li>
  <li>Análise comparativa entre regiões</li>
</ul>

<br>
```{r warning=FALSE, message=FALSE}
#Libraries
library(testthat)
library(rlang)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(plotly)
library(data.table)
library(ggpubr)
library(devtools)
install_github("holtzy/epuRate")
library(epuRate)
library(EpiEstim)
library(tidyr)
library(lubridate)
library(googlesheets)
require(RCurl)
library(viridis)
library(flexdashboard)
library(here)
library(rjson)
library(jsonlite)
library(RCurl)
library(highcharter)
library(here)
library(incidence)
library(purrr)
library(magrittr)
library(RColorBrewer)
library(rjson)
library(readr)
library(readxl)

#Importar dados
covid19pt <-read.csv("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/data.csv", stringsAsFactors = FALSE)


#Data de chr para Date
covid19pt$data <- as.Date(covid19pt$data,"%d-%m-%Y")

```

<br>

## **Portugal**
***

Neste capítulo, iremos abordar de que forma tem evoluído a transmissão de infeção em Portugal com base na evolução do Rt.

<br>

Através deste gráfico, podemos observar que o número médio de pessoas contagiadas por cada infetado chegou a assumir valores de Rt de 4,97 no início da pandemia (07/03/2020), tento posteriormente diminuído na sequência do encerramento das escolas em Portugal (dia 16 de Março) e a entrada do país em estado de emergência (dia 18 de Março).

Em termos gerais, podemos dizer que o valor do R tem vindo a descer gradualmente desde o início do surto em Portugal.



----------
De 17 de abril até agora, segundo os dados mais recentes — ainda não incluídos no relatório —, o Rt voltou a subir, estando a cima de 1 na média nacional. Em termos regionais, sabe-se que, no Norte, está nos 1,01. Na região de Lisboa, subiu até aos 1,18.


Quando o valor do R se encontra acima de 1, significa que a epidemia continua a crescer e que o número de novos casos será superior ao número de casos atuais; por outro lado, se o valor do R se encontrar abaixo de 1, isto significa que a epidemia caminha para o seu fim.

 Essa mesma conclusão é retirada pelo Governo no relatório divulgado esta terça-feira. “A média do R(t) para o período entre 12 e 16 de abril foi de 0,98, significando que, neste período, um caso infetado originou em média menos de 1 caso secundário, o que indica uma redução expressiva da transmissão da infeção desde a implementação das medidas de contenção em Portugal”, lê-se no relatório.

Os especialistas têm sido unânimes no entendimento de que as medidas de restrição só devem ser levantadas com o valor do R abaixo de 1 — ou seja, com a epidemia já em rota descendente. Mais concretamente, e à boleia do exemplo de países como a Noruega, os peritos têm apontado para o valor de 0,7 como um requisito mínimo para que se possa reabrir gradualmente a economia.

Porém, no último domingo, a ministra da Saúde, Marta Temido, anunciou que o valor médio do R em Portugal, que há cerca de duas semanas estava estagnado em torno dos 0,9, havia subido para 1,04. Isto significa que, de acordo com os números mais recentes, o R está acima de 1 e a epidemia se encontra em crescimento em Portugal.







<br>

```{r pressure, fig.align='center', warning=FALSE}
# Criar novas variáveis da variação do nº confirmados (t - (t-1)) e criar uma tabela
covid19pt <- mutate(covid19pt, 
                    confirmados_lag = lag(confirmados),
                    confirmados_var=confirmados-confirmados_lag,
                    
                    confirmados_lag_n = lag(confirmados_arsnorte),
                    confirmados_var_norte=confirmados_arsnorte-confirmados_lag_n,
                    
                    confirmados_lag_centro = lag(x = confirmados_arscentro),
                    confirmados_var_centro=confirmados_arscentro-confirmados_lag_centro,                   
                    
                    confirmados_lag_lvt = lag(confirmados_arslvt),
                    confirmados_var_lvt=confirmados_arslvt-confirmados_lag_lvt, 
                    
                    confirmados_lag_alentejo = lag(confirmados_arsalentejo),
                    confirmados_var_alentejo=confirmados_arsalentejo-confirmados_lag_alentejo, 
                    
                    confirmados_lag_algarve = lag(confirmados_arsalgarve),
                    confirmados_var_algarve=confirmados_arsalgarve-confirmados_lag_algarve, 
                    
                    confirmados_lag_acores = lag(confirmados_acores ),
                    confirmados_var_acores=confirmados_acores-confirmados_lag_acores, 
                    
                    confirmados_lag_madeira = lag(x = confirmados_madeira),
                    confirmados_var_madeira=confirmados_madeira-confirmados_lag_madeira,
)

# Criar tabela
covid19pt_var <- covid19pt %>%
    select(
        data, confirmados_var, confirmados_var_norte, confirmados_var_centro, confirmados_var_lvt, confirmados_var_alentejo, confirmados_var_algarve, confirmados_var_acores, confirmados_var_madeira
    )

# Previsão da evolução
covid_pt_var <- covid19pt_var  %>%
    filter(covid19pt_var$data > as.Date("2020-02-28")) %>%       
    dplyr::mutate(t_start = dplyr::row_number())


### Cálculo do Rt - Uncertainty method --> "uncertain_si"
### Serial Interval (By André Peralta)
### A estimativa do nº reprodutivo efetivo diário foi realizada segundo uma janela de 7dias;
### Recorremos ao EpiEstim, ajustado aos casos importados e assumindo o seguinte serial interval (método uncertain):
### data from https://cmmid.github.io/topics/covid19/current-patterns-transmission/global-time-varying-transmission.html
### -- mean 4.7 (95% CrI: 3.7, 6.0), truncated at 3,7 and 6,0
### -- sd 2.9 (95% CrI: 1.9, 4.9), truncated at 1,9 and 4,9


# Rt Portugal (total)
## Definir o Serial Interval e window
sens_configs <- 
    make_config(
        list(
            mean_si = 4.7, std_mean_si = 0.7,
            min_mean_si = 3.7, max_mean_si = 6.0,
            std_si = 2.9, std_std_si = 0.5,
            min_std_si = 1.9, max_std_si = 4.9,
            n1 = 1000,
            n2 = 100,
            seed = 123456789
        )
    )

## Aplicar a função Estimate_R
Rt_nonparam_si <- estimate_R(covid_pt_var$confirmados_var, 
                             method = "uncertain_si",
                             config = sens_configs
)

## Determinação do Rt (sample from the posterior R distribution)
### Definir a nossa janela com base no t_start
sample_windows <- seq(length(Rt_nonparam_si$R$t_start))

# Map function: applies a function to each element of a list and returns an object of the same type as the input 
# Criar um data frame com valores de R
posterior_R_t <- 
    map(.x = sample_windows,
        .f = function(x) {
            ## Sample from  the posterior R distribution
            posterior_sample_obj <- 
                sample_posterior_R(
                    R = Rt_nonparam_si,
                    n = 1000, 
                    window = x )
            ## Returns a data frame
            posterior_sample_estim <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si$R$t_start[x],
                    window_t_end = Rt_nonparam_si$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj),
                    R_e_q0025 = quantile(posterior_sample_obj, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj, probs = 0.975))
            
            return(posterior_sample_estim)}
    ) %>% 
    ##Combines elements into a single value
    reduce(bind_rows)

## GRÁFICO ggplot
graph_PT<- ggplot(posterior_R_t, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs(title = " Evolução do Número Efetivo Reprodutivo ao longo do tempo",
         subtitle = "Fonte de dados: DGS ",
         x = "Tempo",
         y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust =0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) +
    
    geom_vline(xintercept = as.numeric(as.Date("2020-03-16")), linetype=4, colour = "grey5", alpha = 0.15) +
    geom_vline(xintercept = as.numeric(as.Date("2020-03-18")), linetype=4, colour = "grey5", alpha = 0.15)

### Tornar gráfico interativo
ggplotly(graph_PT) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>

## **Administrações Regionais de Saúde (ARS's)** {.tabset .tabset-fade .tabset-pills}
***

Neste capítulo, iremos abordar de que forma tem evoluído a transmissão de infeção nas ARS's de Portugal.

<br><br>

### ARS Norte
<br>

TEXTO

```{r,fig.align='center', warning=FALSE}
# Rt Diário ARS Norte

## Substituir valores negativos por 0
covid_pt_var[-c(2)] <- replace(covid_pt_var[-c(2)], covid_pt_var[-c(2)] < 0, 0)

## Função
Rt_nonparam_si1 <- 
    estimate_R(
        covid_pt_var$confirmados_var_norte, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows1 <- seq(length(Rt_nonparam_si1$R$t_start))

posterior_R_t1 <- 
    map(
        .x = sample_windows1,
        .f = function(x) {
            
            posterior_sample_obj1 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si1,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim1 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si1$R$t_start[x],
                    window_t_end = Rt_nonparam_si1$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si1$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj1),
                    R_e_q0025 = quantile(posterior_sample_obj1, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj1, probs = 0.975)
                )
            
            return(posterior_sample_estim1)
            
        }
    ) %>% 
    reduce(bind_rows)


posterior_R_e1 <- posterior_R_t1 %>%
    mutate(fit = round(R_e_median, 2),
           lwr=round(R_e_q0025, 2),
           upr=round(R_e_q0975, 2))

## GRÁFICO GGPLOT

graph_PT1<- ggplot(posterior_R_t1, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Norte - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t1$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t1$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
ggplotly(graph_PT1) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>

### ARS Centro

<br>

TEXTO

<br>

```{r}
Rt_nonparam_si2 <- 
    estimate_R(
        covid_pt_var$confirmados_var_centro, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows2 <- seq(length(Rt_nonparam_si2$R$t_start))

posterior_R_t2 <- 
    map(
        .x = sample_windows2,
        .f = function(x) {
            
            posterior_sample_obj2 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si2,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim2 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si2$R$t_start[x],
                    window_t_end = Rt_nonparam_si2$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si2$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj2),
                    R_e_q0025 = quantile(posterior_sample_obj2, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj2, probs = 0.975)
                )
            
            return(posterior_sample_estim2)
        }
    ) %>% 
    reduce(bind_rows)


## GRÁFICO GGPLOT
graph_Centro <- ggplot(posterior_R_t2, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Centro - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t2$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t2$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 

### Tornar gráfico interativo
Centro <- ggplotly(graph_Centro) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```


<br>

### ARS Lisboa e Vale do Tejo
<br>

TEXTO

<br>
```{r}
Rt_nonparam_si3 <- 
    estimate_R(
        covid_pt_var$confirmados_var_lvt, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows3 <- seq(length(Rt_nonparam_si3$R$t_start))

posterior_R_t3 <- 
    map(
        .x = sample_windows3,
        .f = function(x) {
            
            posterior_sample_obj3 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si3,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim3 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si3$R$t_start[x],
                    window_t_end = Rt_nonparam_si3$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si3$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj3),
                    R_e_q0025 = quantile(posterior_sample_obj3, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj3, probs = 0.975)
                )
            
            return(posterior_sample_estim3)
            
        }
    ) %>% 
    reduce(bind_rows)


## GRÁFICO GGPLOT

graph_LVT<- ggplot(posterior_R_t3, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS LVT - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t3$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t3$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
LVT <- ggplotly(graph_LVT) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>

### ARS Alentejo

<br>

TEXTO

<br>
```{r}
Rt_nonparam_si4 <- 
    estimate_R(
        covid_pt_var$confirmados_var_alentejo, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows4 <- seq(length(Rt_nonparam_si4$R$t_start))

posterior_R_t4 <- 
    map(
        .x = sample_windows4,
        .f = function(x) {
            
            posterior_sample_obj4 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si4,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim4 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si4$R$t_start[x],
                    window_t_end = Rt_nonparam_si4$R$t_end[x],
                    date_point = covid19pt_var[covid_pt_var$t_start == Rt_nonparam_si4$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj4),
                    R_e_q0025 = quantile(posterior_sample_obj4, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj4, probs = 0.975)
                )
            
            return(posterior_sample_estim4)
            
        }
    ) %>% 
    reduce(bind_rows)


## GRÁFICO GGPLOT

graph_Alentejo <- ggplot(posterior_R_t4, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Alentejo - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t4$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t4$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
Alentejo <- ggplotly(graph_Alentejo) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>


### ARS Algarve
<br>

TEXTO

<br>

```{r}
Rt_nonparam_si5 <- 
    estimate_R(
        covid_pt_var$confirmados_var_algarve, 
        method = "uncertain_si",
        config = sens_configs
    )


## Posterior sample Rt estimate
sample_windows5 <- seq(length(Rt_nonparam_si5$R$t_start))

posterior_R_t5 <- 
    map(
        .x = sample_windows5,
        .f = function(x) {
            
            posterior_sample_obj5 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si5,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim5 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si5$R$t_start[x],
                    window_t_end = Rt_nonparam_si5$R$t_end[x],
                    date_point = covid19pt_var[covid_pt_var$t_start == Rt_nonparam_si5$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj5),
                    R_e_q0025 = quantile(posterior_sample_obj5, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj5, probs = 0.975)
                )
            
            return(posterior_sample_estim5)
            
        }
    ) %>% 
    reduce(bind_rows)


## GRÁFICO GGPLOT

graph_Algarve<- ggplot(posterior_R_t5, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Algarve - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t5$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t5$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
Algarve <- ggplotly(graph_Algarve) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))

```

<br>

### ARS Açores

<br>

TEXTO

<br>
```{r}
Rt_nonparam_si6 <- 
    estimate_R(
        covid_pt_var$confirmados_var_acores, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows6 <- seq(length(Rt_nonparam_si6$R$t_start))

posterior_R_t6 <- 
    map(
        .x = sample_windows6,
        .f = function(x) {
            
            posterior_sample_obj6 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si6,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim6 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si6$R$t_start[x],
                    window_t_end = Rt_nonparam_si6$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si6$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj6),
                    R_e_q0025 = quantile(posterior_sample_obj6, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj6, probs = 0.975)
                )
            
            return(posterior_sample_estim6)
            
        }
    ) %>% 
    reduce(bind_rows)

## GRÁFICO GGPLOT

graph_Açores <- ggplot(posterior_R_t6, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Açores - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t6$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t6$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
Açores <- ggplotly(graph_Açores) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>

### ARS Madeira

<br>

TEXTO

<br>

```{r}
Rt_nonparam_si7 <- 
    estimate_R(
        covid_pt_var$confirmados_var_madeira, 
        method = "uncertain_si",
        config = sens_configs
    )

## Posterior sample Rt estimate
sample_windows7 <- seq(length(Rt_nonparam_si7$R$t_start))

posterior_R_t7 <- 
    map(
        .x = sample_windows7,
        .f = function(x) {
            
            posterior_sample_obj7 <- 
                sample_posterior_R(
                    R = Rt_nonparam_si7,
                    n = 1000, 
                    window = x
                )
            
            posterior_sample_estim7 <- 
                data.frame(
                    window_index = x,
                    window_t_start = Rt_nonparam_si7$R$t_start[x],
                    window_t_end = Rt_nonparam_si7$R$t_end[x],
                    date_point = covid_pt_var[covid_pt_var$t_start == Rt_nonparam_si7$R$t_end[x], "data"],
                    R_e_median = median(posterior_sample_obj7),
                    R_e_q0025 = quantile(posterior_sample_obj7, probs = 0.025),
                    R_e_q0975 = quantile(posterior_sample_obj7, probs = 0.975)
                )
            
            return(posterior_sample_estim7)
            
        }
    ) %>% 
    reduce(bind_rows)


## GRÁFICO GGPLOT

graph_Madeira <- ggplot(posterior_R_t7, aes(x = date_point, y = R_e_median)) +
    geom_line(colour = "palegreen4",  alpha = 0.5, size = 1.5) +
    geom_ribbon(aes(ymin = R_e_q0025, ymax = R_e_q0975), alpha = 0.15, fill = "palegreen3") +
    
    labs( title = " ARS Madeira - Evolução do Número Efetivo Reprodutivo ao longo do tempo", size= 10,
          subtitle = "Fonte de dados: DGS ",
          x = "Tempo",
          y = "Nº de reprodução efetivo (Rt)"
    ) +
    
    theme_minimal() +
    
    theme(axis.title = element_text(size = 10, hjust = 0.5),
          plot.subtitle = element_text(size= 8),
          axis.title.x = element_text(size = 7),
          axis.title.y = element_text(size = 7),
    ) +
    
    scale_x_date(
        date_breaks = "1 month",
        limits = c(min(covid_pt_var$data), max(posterior_R_t7$date_point))
    ) +
    
    scale_y_continuous(
        breaks = 0:ceiling(max(posterior_R_t7$R_e_q0975)),
        limits = c(0, NA)
    ) +
    
    geom_hline(yintercept = 1, colour= "grey1", alpha= 0.4) 


### Tornar gráfico interativo
Madeira <- ggplotly(graph_Madeira) %>%
    layout(yaxis = list(title = paste0(c(rep("&nbsp;", 20),
                                         "Nº de reprodução efetivo (Rt)",
                                         rep("&nbsp;", 20),
                                         rep("\n&nbsp;", 2)),
                                       collapse = "")))
```

<br>

## **Outros Países** {.tabset .tabset-fade .tabset-pills}
***

TEXTO

<br>

### Itália
<br>

TEXTO

```{r,fig.align='center', warning=FALSE}

```

<br>